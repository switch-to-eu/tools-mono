---
description:
globs:
alwaysApply: true
---
# Monorepo Separation of Concerns - Architectural Rules

**Last Updated**: 2025-01-21
**Context**: Learned during KeepFocus Pomodoro Integration implementation
**Mistake Made**: Initially placed app-specific components in shared packages/ui/blocks/ - WRONG!
a
## ğŸ—ï¸ **Core Principle**

**Shared packages contain GENERIC, reusable code. App-specific packages contain BUSINESS DOMAIN logic.**

## ğŸ“‚ **What Goes Where - Detailed Breakdown**

### **`packages/ui/` - Generic UI Components Only**

#### âœ… **Should Contain:**
- **Generic UI primitives**: `Button`, `Input`, `Card`, `Progress`, `Switch`
- **Generic layout blocks**: `SectionCard`, `Header`, `Calendar` (reusable across apps)
- **Generic form components**: `FormInput`, `FormTextArea` (with i18n support)
- **Generic hooks**: UI-related hooks that work across domains
- **Generic utilities**: `cn()`, color helpers, generic formatters
- **Generic types**: Component prop interfaces, UI state types

#### âŒ **Should NOT Contain:**
- **Business domain types**: `Task`, `Poll`, `User`, `PomodoroSettings`
- **Domain-specific hooks**: `useSettings`, `useTasks`, `usePolls`
- **Business logic**: Validation rules, calculation logic
- **App-specific components**: Components tied to specific business domains
- **ğŸš¨ CRITICAL**: If a component has props like `pomodoros`, `activeTask`, `settings` â†’ **IT'S APP-SPECIFIC!**

### **`apps/{app}/lib/` - Business Domain Logic**

#### âœ… **Should Contain:**
- **Domain types & interfaces**: `Task`, `PomodoroSettings`, `Poll`, `Participant`
- **Business schemas**: Zod schemas for domain validation
- **Domain utilities**: Business-specific calculations, formatters
- **Domain constants**: App-specific constants, enums, defaults
- **Business logic**: Core business rules and operations

**Examples from existing apps:**
- `apps/plotty/lib/interfaces.ts` - Poll domain types
- `apps/plotty/lib/schemas.ts` - Poll validation schemas
- `apps/plotty/lib/crypto.ts` - Poll-specific encryption logic

### **`apps/{app}/hooks/` - App-Specific Hooks**

#### âœ… **Should Contain:**
- **Domain hooks**: `useSettings`, `useTasks`, `usePolls`
- **Business logic hooks**: `useDeletePoll`, `useLoadPoll`, `useVote`
- **State management**: App-specific state management hooks
- **Side effects**: App-specific side effects (localStorage, notifications)

### **`apps/{app}/components/` - App-Specific Components**

#### âœ… **Should Contain:**
- **Domain components**: Components that understand business concepts
- **Page components**: Components specific to app pages/routes
- **Feature components**: Components tied to specific app features

## ğŸ”„ **Component Import Patterns**

### **Direct File Imports (Current Pattern)**
```tsx
// âœ… Correct - Direct imports from individual files
import { Button } from "@workspace/ui/components/button";
import { SectionCard } from "@workspace/ui/blocks/section-card";
import { FormInput } from "@workspace/ui/form/form-input";

// âŒ Wrong - No index.ts files used
import { Button } from "@workspace/ui/components";
```

### **Package.json Exports Handle Path Mapping**
```json
{
  "exports": {
    "./components/*": "./src/components/*.tsx",
    "./blocks/*": "./src/blocks/*.tsx",
    "./form/*": "./src/form/*.tsx"
  }
}
```


## ğŸš¨ **Common Mistakes to Avoid**

### **âŒ Mistake: "This component looks reusable, so it goes in shared packages"**

**Example mistake we made:**
- Created `task-item.tsx` with props: `pomodoros`, `isActive`, `onSetActive`
- **WRONG THINKING**: "It's just displaying a task, seems generic"
- **REALITY**: It has pomodoro-specific props and behavior â†’ **APP-SPECIFIC**

### **âœ… Correct Decision Process:**

1. **Does it have domain-specific props?** (`task`, `poll`, `pomodoros`, `settings`) â†’ **APP-SPECIFIC**
2. **Does it know business concepts?** (what a "pomodoro" is, timer phases, etc.) â†’ **APP-SPECIFIC**
3. **Would other apps use it as-is?** (without changing props/logic) â†’ If NO: **APP-SPECIFIC**

## ğŸ“‹ **Decision Matrix**

When deciding where to put code, ask:

| **Question** | **If YES â†’ `packages/ui/`** | **If NO â†’ `apps/{app}/`** |
|--------------|----------------------------|---------------------------|
| Can this be used by other apps **AS-IS**? | Generic UI component | App-specific component |
| Is this pure UI presentation **without domain knowledge**? | Button, Input, Card | PollForm, TaskItem |
| Does it contain business logic? | No business logic | Business domain logic |
| Does it know about domain concepts? | No domain knowledge | Knows Tasks, Polls, etc. |
| **ğŸš¨ Does it have domain-specific props?** | **Generic props only** | **Domain props = APP-SPECIFIC** |

## ğŸ“š **Examples from Existing Apps**

### **Plotty App Structure (Good Example)**
```
apps/plotty/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ interfaces.ts      # Poll domain types
â”‚   â”œâ”€â”€ schemas.ts         # Poll validation schemas
â”‚   â””â”€â”€ crypto.ts          # Poll-specific logic
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useDeletePoll.ts   # Poll-specific hooks
â”‚   â””â”€â”€ useLoadPoll.ts
â””â”€â”€ components/
    â”œâ”€â”€ poll-form.tsx      # Poll-specific component
    â””â”€â”€ admin-section.tsx  # Uses shared UI + poll logic
```

### **Shared UI Structure (Good Example)**
```
packages/ui/src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ button.tsx         # Generic button
â”‚   â””â”€â”€ progress.tsx       # Generic progress bar
â”œâ”€â”€ blocks/
â”‚   â””â”€â”€ section-card.tsx   # Generic layout block
â””â”€â”€ form/
    â””â”€â”€ form-input.tsx     # Generic form input
```

## ğŸ¯ **Key Takeaway**

**Shared packages are for INFRASTRUCTURE. App packages are for BUSINESS LOGIC.**

The moment you introduce business domain concepts (Tasks, Polls, Users, Settings), it belongs in the app, not the shared package.

